<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp QR - Bot Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        body::before {
            content: '';
            position: absolute;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(59,130,246,0.3), transparent);
            border-radius: 50%;
            top: -200px;
            right: -200px;
            animation: float 6s ease-in-out infinite;
        }
        body::after {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(6,182,212,0.3), transparent);
            border-radius: 50%;
            bottom: -150px;
            left: -150px;
            animation: float 8s ease-in-out infinite reverse;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-30px) scale(1.1); }
        }
        .container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(30px);
            border-radius: 28px;
            padding: 48px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.5) inset;
            max-width: 550px;
            width: 100%;
            animation: fadeIn 0.6s ease-out;
            position: relative;
            z-index: 1;
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(30px) scale(0.95); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        h1 {
            color: #0f172a;
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        .subtitle {
            text-align: center;
            color: #64748b;
            font-size: 14px;
            margin-bottom: 24px;
            font-weight: 500;
        }
        .status { 
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
            margin: 0 auto 32px;
            display: flex;
            justify-content: center;
            letter-spacing: 0.3px;
        }
        .status-connected { 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white;
            box-shadow: 0 4px 12px rgba(16,185,129,0.3);
        }
        .status-qr { 
            background: linear-gradient(135deg, #3b82f6, #2563eb); 
            color: white;
            box-shadow: 0 4px 12px rgba(59,130,246,0.3);
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
            50% { box-shadow: 0 4px 20px rgba(59,130,246,0.6); }
        }
        .status-connecting { 
            background: linear-gradient(135deg, #f59e0b, #d97706); 
            color: white;
            box-shadow: 0 4px 12px rgba(245,158,11,0.3);
        }
        .status-disconnected { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            color: white;
            box-shadow: 0 4px 12px rgba(239,68,68,0.3);
        }
        #qrCode {
            margin: 0 auto 32px;
            padding: 28px;
            background: white;
            border: none;
            border-radius: 24px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 340px;
        }
        #qrCode img { 
            display: block; 
            width: 100%;
            max-width: 280px;
            height: auto;
            border-radius: 16px;
            margin: 0 auto;
        }
        .loading {
            text-align: center;
            padding: 60px 20px;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 4px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-bottom-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .success {
            text-align: center;
            padding: 60px 20px;
        }
        .success-icon { 
            font-size: 72px; 
            margin-bottom: 20px;
            animation: scaleIn 0.5s ease-out;
        }
        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
            margin: 28px 0;
        }
        .info-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            padding: 18px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            text-align: center;
            transition: all 0.3s;
        }
        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .info-label { 
            font-size: 11px; 
            font-weight: 600; 
            color: #64748b; 
            text-transform: uppercase; 
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        .info-value { 
            font-size: 24px; 
            font-weight: 700; 
            color: #0f172a;
        }
        .buttons {
            display: flex;
            gap: 12px;
            margin-top: 28px;
            flex-wrap: wrap;
        }
        button {
            flex: 1;
            min-width: 140px;
            padding: 16px 24px;
            border: none;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: 0.3px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 14px rgba(59,130,246,0.4);
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 24px rgba(59,130,246,0.5); 
        }
        .btn-secondary {
            background: white;
            color: #475569;
            border: 2px solid #cbd5e1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .btn-secondary:hover { 
            background: #f8fafc; 
            border-color: #94a3b8;
            transform: translateY(-2px);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 14px rgba(239,68,68,0.4);
        }
        .btn-danger:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 24px rgba(239,68,68,0.5); 
        }
        .instructions {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            padding: 24px;
            border-radius: 16px;
            margin: 24px 0;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 2px 8px rgba(59,130,246,0.1);
        }
        .instructions h3 { 
            font-size: 15px; 
            color: #1e40af; 
            margin-bottom: 14px;
            font-weight: 700;
        }
        .instructions ol { 
            font-size: 13px; 
            color: #1e3a8a; 
            line-height: 2; 
            padding-left: 22px;
        }
        .instructions li { 
            margin-bottom: 6px;
            font-weight: 500;
        }
        .instructions strong {
            color: #1e40af;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }
            
            .container {
                padding: 32px 24px;
                border-radius: 20px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .subtitle {
                font-size: 13px;
                margin-bottom: 24px;
            }
            
            .status {
                padding: 8px 16px;
                font-size: 12px;
                margin-bottom: 24px;
            }
            
            #qrCode {
                padding: 20px;
                max-width: 100%;
                margin: 0 auto 24px;
            }
            
            #qrCode img {
                max-width: 240px;
            }
            
            .info-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                margin: 20px 0;
            }
            
            .info-card {
                padding: 14px 10px;
            }
            
            .info-label {
                font-size: 10px;
                margin-bottom: 6px;
            }
            
            .info-value {
                font-size: 20px;
            }
            
            .buttons {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px;
            }
            
            button {
                min-width: 100%;
                padding: 14px;
                font-size: 13px;
            }
            
            .instructions {
                padding: 18px;
                margin: 18px 0;
            }
            
            .instructions h3 {
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .instructions ol {
                font-size: 12px;
                line-height: 1.8;
            }
            
            .success {
                padding: 40px 16px;
            }
            
            .success-icon {
                font-size: 56px;
                margin-bottom: 16px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            .container {
                padding: 24px 16px;
                border-radius: 16px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .subtitle {
                font-size: 12px;
            }
            
            #qrCode img {
                max-width: 200px;
            }
            
            .info-value {
                font-size: 18px;
            }
            
            button {
                padding: 12px;
                font-size: 12px;
                gap: 4px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 600px;
            }
            
            .info-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🤖 WhatsApp Bot Manager</h1>
        <p class="subtitle">Sistema de Conexión y Administración</p>
        <div class="status status-connecting" id="statusBadge">
            <span id="statusIcon"></span>
            <span id="statusText">Cargando...</span>
        </div>
        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p style="color: #6b7280; font-weight: 500;">Obteniendo información...</p>
            </div>
        </div>
        <div class="buttons" id="buttons" style="display: none;">
            <button class="btn-primary" onclick="refreshQR()">🔄 Actualizar</button>
            <button class="btn-secondary" onclick="toggleBot()"><span id="botIcon"></span> <span id="botText">Bot</span></button>
            <button class="btn-danger" onclick="logout()">🚪 Salir</button>
        </div>
    </div>
    <script>
        let refreshInterval;
        async function logout() {
            if (!confirm('¿Cerrar sesión?')) return;
            try {
                await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
                window.location.href = '/login';
            } catch (e) { alert('Error al cerrar sesión'); }
        }
        async function toggleBot() {
            try {
                await fetch('/api/whatsapp/toggle-bot', { method: 'POST', credentials: 'include' });
                await loadQR();
            } catch (e) {}
        }
        
        async function restartQRTimer() {
            if (!confirm('¿Reiniciar el timer del QR? Obtendrás 10 minutos nuevos para escanear.')) return;
            
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = '⏳ Reiniciando...';
                
                const res = await fetch('/api/whatsapp/restart-qr-timer', { 
                    method: 'POST', 
                    credentials: 'include' 
                });
                
                if (res.ok) {
                    alert('✅ Timer reiniciado! Tendrás 10 minutos nuevos.\n\nEspera 3 segundos y verás el nuevo QR.');
                    setTimeout(() => loadQR(), 3000);
                } else {
                    alert('❌ Error al reiniciar timer');
                    btn.disabled = false;
                    btn.textContent = '🔄 Obtener 10 minutos nuevos';
                }
            } catch (e) {
                alert('❌ Error de conexión');
                console.error(e);
            }
        }
        
        async function loadQR() {
            try {
                const res = await fetch('/api/whatsapp/status', { credentials: 'include' });
                const data = await res.json();
                updateStatus(data.status);
                updateContent(data);
                updateBot(data.autoBotEnabled);
                document.getElementById('buttons').style.display = 'flex';
            } catch (e) {
                document.getElementById('content').innerHTML = '<div class="loading"><p style="color:#ef4444;">Error de conexión</p></div>';
            }
        }
        function updateStatus(status) {
            const badge = document.getElementById('statusBadge');
            const icon = document.getElementById('statusIcon');
            const text = document.getElementById('statusText');
            badge.className = 'status';
            if (status === 'connected') {
                badge.classList.add('status-connected');
                icon.textContent = '';
                text.textContent = 'Conectado';
            } else if (status === 'qr_received') {
                badge.classList.add('status-qr');
                icon.textContent = '';
                text.textContent = 'Escanea QR';
            } else if (status === 'connecting') {
                badge.classList.add('status-connecting');
                icon.textContent = '';
                text.textContent = 'Conectando';
            } else {
                badge.classList.add('status-disconnected');
                icon.textContent = '';
                text.textContent = 'Desconectado';
            }
        }
        function updateContent(data) {
            const content = document.getElementById('content');
            if (data.status === 'connected') {
                content.innerHTML = `
                    <div class="success">
                        <div class="success-icon">✅</div>
                        <h2 style="font-size:26px;margin-bottom:8px;color:#0f172a;font-weight:700;">WhatsApp Conectado</h2>
                        <p style="color:#64748b;font-size:14px;font-weight:500;">Bot activo y listo para responder</p>
                    </div>
                    <div class="info-grid">
                        <div class="info-card"><div class="info-label">📩 Recibidos</div><div class="info-value">${data.stats.messagesReceived||0}</div></div>
                        <div class="info-card"><div class="info-label">📤 Enviados</div><div class="info-value">${data.stats.messagesSent||0}</div></div>
                        <div class="info-card"><div class="info-label">⏱️ Uptime</div><div class="info-value">${formatTime(data.stats.uptime||0)}</div></div>
                        <div class="info-card"><div class="info-label">🤖 Respuestas</div><div class="info-value">${data.stats.autoReplies||0}</div></div>
                    </div>
                `;
            } else if (data.qrCode) {
                // Construir info de tiempo
                let timeDisplay = '~60s';
                let qrInfo = `Intento #${data.qrAttempts||1}`;
                
                if (data.qrTimeRemaining) {
                    if (data.qrTimeRemaining.expired) {
                        timeDisplay = '⏰ Expirado';
                        qrInfo = 'Tiempo agotado';
                    } else {
                        timeDisplay = data.qrTimeRemaining.displayTime || '~60s';
                        qrInfo = `QR #${data.qrAttempts||1}`;
                    }
                }
                
                content.innerHTML = `
                    <div id="qrCode"><img src="${data.qrCode}" alt="QR Code"></div>
                    <div class="instructions">
                        <h3>📱 Cómo conectar tu WhatsApp:</h3>
                        <ol>
                            <li>Abre <strong>WhatsApp</strong> en tu teléfono</li>
                            <li>Ve a <strong>Ajustes → Dispositivos vinculados</strong></li>
                            <li>Toca <strong>Vincular un dispositivo</strong></li>
                            <li>Escanea este código QR</li>
                        </ol>
                    </div>
                    <div class="info-grid">
                        <div class="info-card">
                            <div class="info-label">🔄 Estado</div>
                            <div class="info-value" style="font-size:16px;">${qrInfo}</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">⏰ Tiempo</div>
                            <div class="info-value" style="font-size:16px;">${timeDisplay}</div>
                        </div>
                    </div>
                    ${data.qrTimeRemaining && data.qrTimeRemaining.expired ? `
                        <div style="background:#fef2f2;padding:16px;border-radius:12px;margin-top:16px;text-align:center;">
                            <p style="color:#dc2626;font-weight:600;margin-bottom:8px;">⏰ Tiempo agotado (10 minutos)</p>
                            <button class="btn-primary" onclick="restartQRTimer()" style="margin:8px auto 0;">
                                🔄 Obtener 10 minutos nuevos
                            </button>
                        </div>
                    ` : ''}
                `;
            } else {
                content.innerHTML = '<div class="loading"><div class="spinner"></div><p style="color:#64748b;font-weight:500;">Generando código QR...</p></div>';
            }
        }
        function updateBot(enabled) {
            document.getElementById('botIcon').textContent = enabled ? '' : '';
            document.getElementById('botText').textContent = enabled ? 'Pausar' : 'Activar';
        }
        function formatTime(s) {
            if (s < 60) return s + 's';
            if (s < 3600) return Math.floor(s/60) + 'm';
            if (s < 86400) return Math.floor(s/3600) + 'h';
            return Math.floor(s/86400) + 'd';
        }
        async function refreshQR() {
            clearInterval(refreshInterval);
            await loadQR();
            refreshInterval = setInterval(loadQR, 5000);
        }
        loadQR();
        refreshInterval = setInterval(loadQR, 5000);
        window.addEventListener('beforeunload', () => clearInterval(refreshInterval));
    </script>
</body>
</html>
